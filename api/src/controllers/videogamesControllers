const axios = require("axios");
const { userInfo } = require("os");
require("dotenv").config();
const { API_KEY } = process.env;
const { Videogame } = require("../db");
const infoCleaner = require("../utils/genericFunctions");
const { Sequelize } = require("sequelize");
const { Op } = require("sequelize");

const createVideogameDB = async (name, description, platform, image, release, rating) => {
    const newVideogame = await Videogame.create({ name, description, platform, image, release, rating });

    return newVideogame;
}

const getVideogameById = async (id, source) => {
    const videogame = source === "api"
        ? (await axios.get(`https://api.rawg.io/api/games/${id}?key=${API_KEY}`))
            .data
        : await Videogame.findByPk(id);
    return videogame;
}

const getAllVideogames = async () => {
    const videogameDB = await Videogame.findAll();
    const infoApi = [];
    infoApi.push((await axios(`https://api.rawg.io/api/games?key=${API_KEY}`) // https://jsonplaceholder.typicode.com/users/
    ).data); 
    
    const videogameApi = infoCleaner(infoApi[0].results);

    const first20Videogames = [...videogameApi.slice(0, 20)];console.log(first20Videogames);

    return [...videogameDB, ...first20Videogames]; // esto junta los dos arrays
}

const getVideogameByName = async (videogame) => {
    try {
        const infoApi = (await axios.get(`https://api.rawg.io/api/games?search=${videogame}&key=${API_KEY}`) // https://jsonplaceholder.typicode.com/users/
        ).data;

        const videogameApi = infoCleaner(infoApi.results);

        function buscarObjeto(nombre) {
            let minusculas = videogame;
            return nombre.name.toLowerCase() === minusculas.toLowerCase();
        }

        let results = await videogameApi.find(buscarObjeto);

        // let results = await videogameApi.findAll({
        //     where: {
        //         [Sequelize.Op.iLike]: {name: `%${videogame}`}
        //     }
        // }); 

        const videogameDB = await Videogame.findAll({ where: { name: videogame } });

        if (results) return [results, ...videogameDB]

    } catch (error) {
        return { error: error.message }
    }
}

module.exports = { createVideogameDB, getVideogameById, getAllVideogames, getVideogameByName };